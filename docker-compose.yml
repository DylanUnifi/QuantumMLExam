services:
  trainer:
    build:
      context: .
      args:
        BASE_IMAGE: ${BASE_IMAGE:-python:3.12-slim}
        TORCH_INDEX_URL: ${TORCH_INDEX_URL:-https://download.pytorch.org/whl/cpu}
        TORCH_SPEC: ${TORCH_SPEC:-torch==2.3.1 torchvision==0.18.1}
    image: quantum-ml-exam
    working_dir: /app
    command: ["python", "main.py", "--help"]
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./:/app
      - ./outputs:/app/outputs

  trainer-gpu:
    profiles: ["gpu"]
    build:
      context: .
      args:
        BASE_IMAGE: ${BASE_IMAGE:-pytorch/pytorch:2.3.1-cuda12.1-cudnn8-runtime}
        TORCH_INDEX_URL: ${TORCH_INDEX_URL:-https://download.pytorch.org/whl/cu121}
        TORCH_SPEC: ${TORCH_SPEC:-torch==2.3.1+cu121 torchvision==0.18.1+cu121}
    image: quantum-ml-exam-gpu
    working_dir: /app
    command: ["python", "main.py", "--help"]
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - ./:/app
      - ./outputs:/app/outputs
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
